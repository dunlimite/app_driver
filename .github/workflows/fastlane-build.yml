name: Fastlane Build and Distribute

on:
  push:
    branches: [ main, app_driver ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - debug
        - release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.4'
        cache: 'yarn'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: false

    - name: Install dependencies
      run: |
        yarn install --frozen-lockfile
        bundle install

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x android/gradlew

    - name: Run Fastlane
      env:
        FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        APP_IDENTIFIER: com.deliveryapp
        APP_NAME: App Driver
        PACKAGE_NAME: com.deliveryapp
        VERSION_NAME: ${{ github.ref_name == 'main' && '1.0.0' || '1.0.0-dev' }}
        VERSION_CODE: ${{ github.run_number }}
        MIN_SDK_VERSION: 21
        TARGET_SDK_VERSION: 34
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          bundle exec fastlane android build_${{ github.event.inputs.build_type }}
        else
          bundle exec fastlane android build_and_distribute
        fi

    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_type || 'release' }}-apk
        path: android/app/build/outputs/apk/*/app-*.apk
        retention-days: 30

    - name: Send email notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Build Status: ${{ job.status }} - ${{ github.repository }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          Build Status: ${{ job.status }}
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          Build Type: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_type || 'release' }}

          ${{ job.status == 'success' && '✅ Build completed successfully! APK has been uploaded to Firebase App Distribution.' || '❌ Build failed. Please check the logs for details.' }}

          View the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

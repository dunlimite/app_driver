# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:android)

platform :android do
  desc "Build and upload APK to Firebase App Distribution"
  lane :build_and_distribute do
    # Clean and build the project
    gradle(
      task: "clean",
      project_dir: "android"
    )

    # Build the APK
    gradle(
      task: "assembleRelease",
      project_dir: "android"
    )

    # Upload to Firebase App Distribution
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      apk_path: "android/app/build/outputs/apk/release/app-release.apk",
      groups: "testers", # You can change this to your desired group
      release_notes: "Automated build from GitHub Actions - #{ENV['GITHUB_SHA']}"
    )
  end

  desc "Build debug APK"
  lane :build_debug do
    gradle(
      task: "clean",
      project_dir: "android"
    )

    gradle(
      task: "assembleDebug",
      project_dir: "android"
    )
  end

  desc "Build release APK without distribution"
  lane :build_release do
    gradle(
      task: "clean",
      project_dir: "android"
    )

    gradle(
      task: "assembleRelease",
      project_dir: "android"
    )
  end

  desc "Run Detox E2E tests and capture Login screen screenshots"
  lane :e2e_screenshots do
    screenshots_dir = File.join(Dir.pwd, "e2e", "screenshots")

    UI.message "ğŸ§¹ Cleaning old screenshots..."
    FileUtils.rm_rf(screenshots_dir)
    FileUtils.mkdir_p(screenshots_dir)

    UI.message "ğŸ”¨ Building debug APK for Detox..."
    gradle(
      task: "assembleDebug",
      project_dir: "android"
    )

    UI.message "ğŸ”¨ Building Android test APK..."
    gradle(
      task: "assembleAndroidTest",
      project_dir: "android",
      properties: {
        "testBuildType" => "debug"
      }
    )

    UI.message "ğŸ“± Running Detox E2E tests..."
    begin
      sh(
        "yarn detox test " \
        "--configuration android.emu.debug " \
        "--headless " \
        "--record-logs all " \
        "--take-screenshots all " \
        "--artifacts-location e2e/screenshots/ " \
        "--loglevel verbose"
      )
      UI.success "âœ… E2E tests passed! Screenshots saved to e2e/screenshots/"
    rescue => e
      UI.error "âŒ E2E tests failed: #{e.message}"
      UI.important "ğŸ“¸ Partial screenshots may still exist in e2e/screenshots/"
      # Don't raise â€” let CI still upload whatever screenshots were captured
    end

    screenshot_count = Dir.glob("#{screenshots_dir}/**/*.png").count
    UI.message "ğŸ“¸ Total screenshots captured: #{screenshot_count}"
  end

end

